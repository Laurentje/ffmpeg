name: Build Media3 FFmpeg AAR (1.5.1)

on:
  workflow_dispatch:
    inputs:
      media_ref:
        description: "androidx/media tag/branch (örn: 1.5.1)"
        required: true
        default: "1.5.1"
      ffmpeg_ref:
        description: "FFmpeg tag/branch (örn: n6.1.1)"
        required: true
        default: "n6.1.1"
      ndk_version:
        description: "Android NDK version (sdkmanager formatı) - media3 genelde 25.1 ister"
        required: true
        default: "25.1.8937393"
      api_level:
        description: "Android API level (örn: 21, 23)"
        required: true
        default: "23"
      enabled_decoders:
        description: "FFmpeg enabled decoders (space-separated)"
        required: true
        default: "aac opus mp3 flac alac ac3 eac3"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (workflow repo)
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git make pkg-config yasm nasm autoconf automake libtool cmake ninja-build python3

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android platform + NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "platforms;android-${{ inputs.api_level }}" "ndk;${{ inputs.ndk_version }}"
          echo "NDK=$ANDROID_SDK_ROOT/ndk/${{ inputs.ndk_version }}" >> $GITHUB_ENV

      - name: Clone androidx/media
        run: |
          rm -rf media
          git clone --branch "${{ inputs.media_ref }}" https://github.com/androidx/media.git media

      - name: Clone FFmpeg source
        run: |
          rm -rf ffmpeg-src
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      - name: Link FFmpeg into decoder_ffmpeg jni folder
        run: |
          JNI_DIR="media/libraries/decoder_ffmpeg/src/main/jni"
          mkdir -p "$JNI_DIR"
          rm -f "$JNI_DIR/ffmpeg"
          ln -s "$GITHUB_WORKSPACE/ffmpeg-src" "$JNI_DIR/ffmpeg"

      - name: Build FFmpeg native libs
        shell: bash
        run: |
          cd media/libraries/decoder_ffmpeg/src/main/jni
          chmod +x build_ffmpeg.sh

          FFMPEG_MODULE_PATH="$(cd .. && pwd)"
          HOST_PLATFORM="linux-x86_64"
          ANDROID_ABI="${{ inputs.api_level }}"

          read -ra DEC <<< "${{ inputs.enabled_decoders }}"
          ./build_ffmpeg.sh "$FFMPEG_MODULE_PATH" "$NDK" "$HOST_PLATFORM" "$ANDROID_ABI" "${DEC[@]}"

      - name: Patch CMakeLists (add libc correctly)
        run: |
          python3 - <<'PY'
          import re
          from pathlib import Path

          p = Path("media/libraries/decoder_ffmpeg/src/main/jni/CMakeLists.txt")
          s = p.read_text()

          # ffmpegJNI target_link_libraries bloğunu bul
          m = re.search(r"target_link_libraries\(\s*ffmpegJNI\b.*?\)", s, re.S)
          if not m:
            raise SystemExit("ERROR: target_link_libraries(ffmpegJNI ...) not found")

          block = m.group(0)

          # Zaten c varsa dokunma
          if re.search(r"(?<![A-Za-z0-9_])c(?![A-Za-z0-9_])", block):
            print("OK: libc 'c' already present")
            raise SystemExit(0)

          # Keyword signature varsa (PUBLIC/PRIVATE/INTERFACE), c'yi keyword'den sonra ekle
          if re.search(r"target_link_libraries\(\s*ffmpegJNI\s+(PUBLIC|PRIVATE|INTERFACE)\b", block):
            new_block = re.sub(
              r"(target_link_libraries\(\s*ffmpegJNI\s+(?:PUBLIC|PRIVATE|INTERFACE)\b)",
              r"\1 c",
              block,
              count=1
            )
          else:
            # Eski signature: target_link_libraries(ffmpegJNI a b c)
            new_block = re.sub(
              r"(target_link_libraries\(\s*ffmpegJNI\b)",
              r"\1 c",
              block,
              count=1
            )

          s2 = s[:m.start()] + new_block + s[m.end():]
          p.write_text(s2)

          print("PATCHED: added 'c' to ffmpegJNI target_link_libraries with correct ordering")
          PY

      - name: Build AAR
        run: |
          cd media
          chmod +x ./gradlew
          ./gradlew :lib-decoder-ffmpeg:assembleRelease --stacktrace

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: media3-decoder-ffmpeg-aar
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*release*.aar
