name: Build Media3 FFmpeg AAR (1.5.1)

on:
  workflow_dispatch:
    inputs:
      media_ref:
        description: "androidx/media tag/branch (örn: 1.5.1)"
        required: true
        default: "1.5.1"
      ffmpeg_ref:
        description: "FFmpeg tag/branch (örn: n6.1.1)"
        required: true
        default: "n6.1.1"
      ndk_version:
        description: "Android NDK version (sdkmanager formatı)"
        required: true
        default: "25.2.9519653"
      api_level:
        description: "Android API level (örn: 21, 23)"
        required: true
        default: "23"
      enabled_decoders:
        description: "FFmpeg enabled decoders (space-separated)"
        required: true
        default: "aac opus mp3 flac alac ac3 eac3"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (workflow repo)
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git make pkg-config yasm nasm autoconf automake libtool cmake ninja-build python3

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android platform + NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "platforms;android-${{ inputs.api_level }}" "ndk;${{ inputs.ndk_version }}"
          echo "NDK=$ANDROID_SDK_ROOT/ndk/${{ inputs.ndk_version }}" >> $GITHUB_ENV

      - name: Clone androidx/media
        run: |
          rm -rf media
          git clone --branch "${{ inputs.media_ref }}" https://github.com/androidx/media.git media

      - name: Clone FFmpeg source
        run: |
          rm -rf ffmpeg-src
          git clone --depth 1 --branch "${{ inputs.ffmpeg_ref }}" https://github.com/FFmpeg/FFmpeg.git ffmpeg-src

      - name: Link FFmpeg into decoder_ffmpeg jni folder
        run: |
          JNI_DIR="media/libraries/decoder_ffmpeg/src/main/jni"
          mkdir -p "$JNI_DIR"
          rm -f "$JNI_DIR/ffmpeg"
          ln -s "$GITHUB_WORKSPACE/ffmpeg-src" "$JNI_DIR/ffmpeg"
          echo "=== jni dir ==="
          ls -la "$JNI_DIR"
          echo "=== ffmpeg dir ==="
          ls -la "$JNI_DIR/ffmpeg" | head -n 30

      - name: Build FFmpeg native libs
        shell: bash
        run: |
          cd media/libraries/decoder_ffmpeg/src/main/jni
          chmod +x build_ffmpeg.sh

          FFMPEG_MODULE_PATH="$(cd .. && pwd)"
          HOST_PLATFORM="linux-x86_64"
          ANDROID_ABI="${{ inputs.api_level }}"

          echo "FFMPEG_MODULE_PATH is $FFMPEG_MODULE_PATH"
          echo "NDK path is $NDK"
          echo "Host platform is $HOST_PLATFORM"
          echo "ANDROID_ABI is $ANDROID_ABI"
          echo "Enabled decoders are ${{ inputs.enabled_decoders }}"

          read -ra DEC <<< "${{ inputs.enabled_decoders }}"
          ./build_ffmpeg.sh "$FFMPEG_MODULE_PATH" "$NDK" "$HOST_PLATFORM" "$ANDROID_ABI" "${DEC[@]}"

      - name: Patch CMakeLists to link libc (fix undefined stderr)
        run: |
          python3 - <<'PY'
          import re
          from pathlib import Path

          p = Path("media/libraries/decoder_ffmpeg/src/main/jni/CMakeLists.txt")
          s = p.read_text()

          # target_link_libraries(ffmpegJNI ...) içine 'c' ekle (yoksa)
          m = re.search(r"target_link_libraries\(\s*ffmpegJNI\b", s)
          if not m:
              raise SystemExit("ERROR: target_link_libraries(ffmpegJNI ...) not found in CMakeLists.txt")

          if re.search(r"target_link_libraries\(\s*ffmpegJNI\b[^)]*\bc\b", s, re.S):
              print("OK: 'c' already present in target_link_libraries(ffmpegJNI ...)")
          else:
              s = re.sub(r"(target_link_libraries\(\s*ffmpegJNI\b)", r"\1 c", s, count=1)
              p.write_text(s)
              print("PATCHED: added 'c' to target_link_libraries(ffmpegJNI ...)")

          # debug: print the line(s)
          print("---- target_link_libraries lines ----")
          for i, line in enumerate(s.splitlines(), 1):
              if "target_link_libraries" in line:
                  print(f"{i}: {line}")
          PY

      - name: Build AAR
        run: |
          cd media
          chmod +x ./gradlew
          ./gradlew :lib-decoder-ffmpeg:assembleRelease --stacktrace

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: media3-decoder-ffmpeg-aar
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*release*.aar
